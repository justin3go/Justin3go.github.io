<!DOCTYPE html>
<html lang="zh-CH">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue3 编译器 | Justin3go's Blog-🖊</title>
    <meta name="description" content="我的技术博客，用心记录知识碎片，汇总整理程序员知识。">
    <link rel="stylesheet" href="/assets/style.8a11ac97.css">
    <link rel="modulepreload" href="/assets/Home.8f5cc243.js">
    <link rel="modulepreload" href="/assets/app.91b9ffc3.js">
    <link rel="modulepreload" href="/assets/汇总分类_前端框架_02Vue3编译器.md.893c89ed.lean.js">
    
    <link rel="icon" href="/ava.ico">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-alpha/dist/katex.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css">
  <meta name="twitter:title" content="Vue3 编译器 | Justin3go&#39;s Blog-🖊">
  <meta property="og:title" content="Vue3 编译器 | Justin3go&#39;s Blog-🖊">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="Justin3go&#39;s Blog-🖊, back to home" data-v-675d8756 data-v-cc01ef16><!----> Justin3go&#39;s Blog-🖊</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/" data-v-b8818f8c>首页 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item active" href="/汇总分类/" data-v-b8818f8c>汇总分类 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/推荐/" data-v-b8818f8c>站长推荐 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://space.bilibili.com/434542518" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>B站 <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/Justin3go" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><!--]--><!----><!----></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/" data-v-b8818f8c>首页 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item active" href="/汇总分类/" data-v-b8818f8c>汇总分类 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/推荐/" data-v-b8818f8c>站长推荐 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://space.bilibili.com/434542518" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>B站 <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/Justin3go" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><!--]--><!----><!----></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/算法与数据结构/">算法与数据结构</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/算法与数据结构/01基础概念">基础概念</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/算法与数据结构/02线性表">线性表</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/算法与数据结构/03栈和队列">栈和队列</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/算法与数据结构/04数组">数组</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/算法与数据结构/05树">树</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/算法与数据结构/06图">图</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/算法与数据结构/07查找">查找</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/算法与数据结构/08排序">排序</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/算法与数据结构/09散列表实现查找">散列表实现查找</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/计算机基础知识/">计算机基础知识</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/计算机基础知识/01计算机网络面试题汇总">计算机网络面试题汇总</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/JavaScript/">JavaScript</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/CSS相关/">CSS相关</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/CSS相关/01HTML面试题汇总">HTML面试题汇总</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/CSS相关/02都2022年了，还是得学圣杯布局与双飞翼布局">圣杯布局与双飞翼布局</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/CSS相关/03CSS面试题汇总">CSS面试题汇总</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/前端框架/">前端框架</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/前端框架/01Vue3是如何运行的">Vue3是如何运行的</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/汇总分类/前端框架/02Vue3编译器">Vue3编译器</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#编译器基本作用">编译器基本作用</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#静态优化选项">静态优化选项</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#动态相关优化">动态相关优化</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#block有什么作用？">block有什么作用？</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#使用v-if等结构指令">使用v-if等结构指令</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/前端框架/03虚拟DOM">虚拟DOM</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/前端框架/04Vue3-Reactivity">Vue3-Reactivity</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/前端框架/05Mini-Vue">Mini-Vue</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/前端框架/06Vue3其他">Vue3其他</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/UI组件库/">UI组件库</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/数据相关/">数据相关</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/后端储备/">后端储备</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/汇总分类/AI相关/">AI相关</a><!----></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h1 id="vue3-编译器" tabindex="-1">Vue3 编译器 <a class="header-anchor" href="#vue3-编译器" aria-hidden="true">#</a></h1><blockquote><p>本章主要介绍Vue3编译器的作用，这个编译器是如何提高性能的，静态dom与动态dom的不同处理，缓存的使用以及块的作用。</p><p>致谢Vue Mastery非常好的课程，可以转载，但请声明源链接：文章源链接<a href="https://justin3go.com" target="_blank" rel="noopener noreferrer">justin3go.com</a>(有些latex公式某些平台不能渲染可查看这个网站)</p></blockquote><h2 id="编译器基本作用" tabindex="-1">编译器基本作用 <a class="header-anchor" href="#编译器基本作用" aria-hidden="true">#</a></h2><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130161337653.png" alt="image-20220130161337653" style="zoom:80%;"><div class="language-html line-numbers-mode"><pre><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>foo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>上面是源模板，下面是生成的渲染函数代码</p><div class="language-javascript line-numbers-mode"><pre><code><span class="token punctuation">{</span>
    <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ssrRender</span><span class="token punctuation">(</span><span class="token parameter">_ctx<span class="token punctuation">,</span> _push<span class="token punctuation">,</span> _parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">_push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;foo&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>有什么作用：在开发过程中，用这个来调试编译器，知道实际是怎么运行的；</p><h2 id="静态优化选项" tabindex="-1">静态优化选项 <a class="header-anchor" href="#静态优化选项" aria-hidden="true">#</a></h2><p>右上角的是一些优化选项，这里都是静态的，所以可以打开这个选项：</p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130161539315.png" alt="image-20220130161539315" style="zoom:80%;"><p>然后对应的编译代码也会发生变化：</p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130161633225.png" alt="image-20220130161633225" style="zoom:80%;"><p>以便在每次组件更新的时候可以在每个渲染器上重用它，一旦一个节点被提升，它就会被创建一次在渲染函数之外，在以后的每一次渲染中，它将在这里重新使用，两个好处：</p><ul><li>避免重新创建对象，然后扔掉（垃圾回收相关的知识）</li><li>在模式算法中，当看到两个节点在同一位置时，在严格平等的情况下，可以跳过它，因为我们知道它永远不会改变</li></ul><h2 id="动态相关优化" tabindex="-1">动态相关优化 <a class="header-anchor" href="#动态相关优化" aria-hidden="true">#</a></h2><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130162921554.png" alt="image-20220130162921554" style="zoom:80%;"><p>这里绑定了click侦听器，编译器会生成一个补丁标志</p><p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130163034888.png" alt="image-20220130163034888"></p><p>通常使用简单的虚拟DOM渲染算法，不管有多少东西在div自身上</p><p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130163318622.png" alt="image-20220130163318622"></p><p>这整个对象必须作为一个整体来diff：</p><p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130163356416.png" alt="image-20220130163356416"></p><p><strong>所以</strong>即使从模板中我们可以看到这个ID实际上是静态的，永远不会改变，我们还是会遍历整个对象，只是为了确保它不会改变，因为运行时没有足够的信息来知道这方面；</p><p>但是，使用Vue3的编译器，这个补丁和数组结合在一起，<strong>为运行提供足够的信息</strong>&lt;表示有些props会改变，但唯一可能改变的是onClick，因为它适合暴露在外的东西结合在一起&gt;</p><p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130163720130.png" alt="image-20220130163720130"></p><p>所以我们可以<strong>跳过</strong>此props上的对象<strong>枚举</strong>，忽略那些已经被编译器推断永远不会改变的props</p><p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130163956428.png" alt="image-20220130163956428"></p><blockquote><p>总的，性能优化的方面做了许多的更新，在虚拟DOM中，当情况发生变化时，并没有检查整个节点的所有属性和元素，检查的是一些具体的东西通过添加类似的提示&lt;确切地说，这些是编译器生成的提示，以帮助运行时更高效&gt;</p></blockquote><p>但是很多时候，你并不打算改变事件处理程序，所以有一个选项是默认打开的：</p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130164645796.png" alt="image-20220130164645796" style="zoom:80%;"><p>这里使用了一些智能JavaScript来缓存事件处理程序，这里将它变成了一个内联函数，并在<strong>第一次渲染时将其缓存</strong>，后续渲染就始终使用同一个内联处理程序了，所以我们总是传递相同的函数，但是这里面的函数会访问ctx.onClick</p><p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130165056621.png" alt="image-20220130165056621"></p><p>**重点：**我们注意到补丁标志与onClick数组不见了，这意味着现在这个vnode当我们试图修补它的时候，它实际上并不需要被修补，因为这(id: “foo”)是静态的，而事件处理程序也已经被缓存，当被调用时，它总是指向最新的onClick，所以即使onClick下面发生了变化，我们不需要对vnode本身做任何事情，可以理解为vnode里面存的是指向，具体的程序存在缓存中，并且实时更新为最新的。所以，现在我们在修补过程中可以完全跳过整个节点。</p><p>这一点非常重要，因为在组件中，如果要将事件处理程序添加到组件中，会导致子组件不必要地重新渲染的最常见的情况之一是指使用类似内联事件处理程序</p><p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130171548734.png" alt="image-20220130171548734"></p><p>或者当你些foo的时候，你给它一个参数，这也是一个隐式的内联处理程序</p><p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130171857895.png" alt="image-20220130171857895"></p><p>所以这些在Vue2中，即使什么都没有改变，它仍然会导致子组件在父组件重新渲染时而重新渲染，在大型应用，这会引起连锁反应，因为你在向下传递函数，在每次渲染时，都会创建一个新的内联函数，会导致所有这些收到那个prop的子组件重新渲染；</p><p>所以在Vue3中使用处理缓存，极大地减少了在大型组件树中发生不必要的渲染</p><h2 id="block有什么作用？" tabindex="-1">block有什么作用？ <a class="header-anchor" href="#block有什么作用？" aria-hidden="true">#</a></h2><p>当根div被创建时，就像block一样：</p><p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130172700320.png" alt="image-20220130172700320"></p><p>假如有一个这样的临时结构：</p><p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130173022893.png" alt=""></p><p>在右边，我们可以看到它<strong>被提升了</strong>，_hoisted_1</p><p>想象这是一个手动写的非优化虚拟DOM树，在更新时，你要确保DOM结构是一致的，如果这是手动编写的，那么运行时就没有关于这个DOM树是否稳定的信息了，它不能做出仍任何假设因为节点顺序可能已经改变了或者div--&gt;p，所以运行时需格外小心，它必须检查每个节点以确保它没有变成别的东西，如果有props的话就要把所有的props都区分开来确保props没有改变，而说孩子节点，事实上，它必须区分两个子数组，以确保它们没有四处走动或者没有新的孩子节点加入或删除。</p><div class="language-html line-numbers-mode"><pre><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>会得到这样的结果：</p><div class="language-javascript line-numbers-mode"><pre><code><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
            <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&#39;span&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;hello&#39;</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>你可以想象最终的Json结构，底层数据结构可能是这个样子</p><div class="language-javascript line-numbers-mode"><pre><code><span class="token keyword">const</span> vdom <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&#39;span&#39;</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token string">&#39;hello&#39;</span>  <span class="token comment">// 当这里变化为msg(#)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>像这样的结构，更新时，它将有两个快照(新旧)</p><p>“#”部分: 如果我们不提供更多的提示，渲染器并不知道发生了什么变化，所以上述结构必须经过一个相对暴力的算法递归遍历整颗树，比较新旧；</p><p>对于中小型应用，这种方法并不会达到性能瓶颈，但是对于大型应用：当你点击某个东西时，可能你的应用程序会有10个组件同时被触发再更新，这就是JavaScript成本开始增加的时候，可能阻塞或卡顿。这时候人们就开始了解如何手动优化组件树来避免不必要的重新渲染，这就是Vue的优势：尝试让框架变得聪明--增加了一些提示以及如何实现这一目标的优化；</p><p>回到块的想法中，稍微修改一点变为一个好的例子，加入使整颗树变为动态的，使其不能被提升</p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130182130089.png" alt="image-20220130182130089" style="zoom:80%;"><p>理想情况下，我们知道这个div不会改变，唯一可能改变的就是这个span;</p><p>如果在其他地方添加一些不相关的节点</p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130183223429.png" alt="image-20220130183223429" style="zoom:80%;"><p>作为人类，我们可以很清楚的知道整颗DOM树只有span那个节点在变化，但是如果没有编译器生成的提示，虚拟DOM渲染器只看到JavaScript树，它并不知道哪个部分会改变，所以编译器的工作就是提供这些信息，运行的时候就知道可以跳过很多不必要的工作，这里就是直接到span这里</p><p>使用的方法就是block，将模板的根变成block</p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130183732355.png" alt="image-20220130183732355" style="zoom:80%;"><p>注意这里有一个openBlock调用，当块打开时，所有表达式、所有的孩子会被评估，这是在欺骗JavaScript，想法是当你创建这样一个节点时</p><p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130190120227.png" alt="image-20220130190120227"></p><p>因为它是动态的，它有我们称之为补丁标志的东西，应该被跟踪，<strong>当我们说tracked时，这个节点就会被添加到当前打开的block作为动态节点</strong>。所以整个调用之后，这个根div将有一个额外的属性称为动态子节点，它将只包含此节点，同时我们还有完整的结构通过正常的子层级，<strong>但是每个block都有一个额外的数组，只跟踪其中的动态节点</strong>，所以这个span标签可以无论多深，block将只跟踪动态节点在一个扁平数组中。</p><h2 id="使用v-if等结构指令" tabindex="-1">使用v-if等结构指令 <a class="header-anchor" href="#使用v-if等结构指令" aria-hidden="true">#</a></h2><blockquote><p>可能改变节点的结构</p></blockquote><p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130191014035.png" alt="image-20220130191014035"></p><p>当这个被切换时，整个div就会从树上消失，所以对于这个根block，它再也不能对此做出安全的假设了，<strong>相反，我们把这个完整的if部分变成一个块（它自己的）这个块被跟踪了，作为父块的动态子级</strong>。所以我们有嵌套的块，每个块将在扁平的数组中跟踪它自己的动态子对象</p><p>数个节点中可能只有几个这样的v-if和v-for，所以，我们基本上还是需要遍历block树。然而，大多数情况下是扁平数组迭代，而不是去diff和比较检查潜在的节点移动，所以效率更高，减少了递归的数量；</p><img src="https://webplus-cn-shenzhen-s-6130b804f968dd14cecc43e2.oss-cn-shenzhen.aliyuncs.com/blogs/image-20220130192130335.png" alt="image-20220130192130335" style="zoom:80%;"><p>对于每个节点，补丁标志本身还编码了关于什么样的工作的信息，比如上面这个TEXT标志意味着：当你试图区分这个节点时，你只需检查它的文本内容，而不必考虑它的props。将所有这些结合起来，编译器将真正生成运行时渲染函数，它运行运行时利用所有的这些提示做尽可能少的工作</p><!----></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-fb8d84c6><div class="edit" data-v-fb8d84c6><div class="edit-link" data-v-fb8d84c6 data-v-1ed99556><!----></div></div><div class="updated" data-v-fb8d84c6><!----></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><a class="link" href="/汇总分类/前端框架/01Vue3是如何运行的" data-v-38ede35f><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-38ede35f><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-38ede35f>Vue3是如何运行的</span></a></div><div class="next" data-v-38ede35f><a class="link" href="/汇总分类/前端框架/03虚拟DOM" data-v-38ede35f><span class="text" data-v-38ede35f>虚拟DOM</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-38ede35f><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"3afdded2\",\"推荐_09散列表实现查找.md\":\"a0129570\",\"推荐_index.md\":\"5049cd66\",\"汇总分类_ai相关_index.md\":\"bbdd6499\",\"汇总分类_css相关_01html面试题汇总.md\":\"2a074e53\",\"汇总分类_css相关_02都2022年了，还是得学圣杯布局与双飞翼布局.md\":\"62efafab\",\"汇总分类_css相关_03css面试题汇总.md\":\"a15b2ad2\",\"汇总分类_css相关_index.md\":\"6a0a34e0\",\"汇总分类_javascript_index.md\":\"3ce5f726\",\"汇总分类_ui组件库_index.md\":\"70f07efb\",\"汇总分类_index.md\":\"f71b1756\",\"汇总分类_前端框架_01vue3是如何运行的.md\":\"716b2731\",\"汇总分类_前端框架_02vue3编译器.md\":\"893c89ed\",\"汇总分类_前端框架_03虚拟dom.md\":\"7355952b\",\"汇总分类_前端框架_04vue3-reactivity.md\":\"36e6c525\",\"汇总分类_前端框架_05mini-vue.md\":\"c29736fa\",\"汇总分类_前端框架_06vue3其他.md\":\"6831d3d2\",\"汇总分类_前端框架_index.md\":\"e7dfa1bf\",\"汇总分类_后端储备_index.md\":\"f4dc9282\",\"汇总分类_数据相关_index.md\":\"c9ac74c7\",\"汇总分类_算法与数据结构_01基础概念.md\":\"ef8612df\",\"汇总分类_算法与数据结构_02线性表.md\":\"17383805\",\"汇总分类_算法与数据结构_03栈和队列.md\":\"a6b506f9\",\"汇总分类_算法与数据结构_04数组.md\":\"9b3db48b\",\"汇总分类_算法与数据结构_05树.md\":\"4aa0c0f2\",\"汇总分类_算法与数据结构_06图.md\":\"732d31c7\",\"汇总分类_算法与数据结构_07查找.md\":\"6084bba2\",\"汇总分类_算法与数据结构_08排序.md\":\"629e47b1\",\"汇总分类_算法与数据结构_09散列表实现查找.md\":\"0a08bdcd\",\"汇总分类_算法与数据结构_index.md\":\"8a36c1d2\",\"汇总分类_计算机基础知识_01计算机网络面试题汇总.md\":\"e27f49ac\",\"汇总分类_计算机基础知识_index.md\":\"c843bd69\"}")</script>
    <script type="module" async src="/assets/app.91b9ffc3.js"></script>
    
  </body>
</html>